import{f7 as F,bO as $,dX as H,dY as Y,eJ as R,ep as q,c1 as D,c3 as J,cM as U,cZ as X,bL as x,ca as I,c8 as v,pn as Z,cs as k,n_ as B,po as G}from"./index-DPJiPkbh.js";import{t as K,l as Q}from"./Indices-ijvqWnhD.js";import{t as V}from"./basicInterfaces-DngWxyLO.js";import{s as T}from"./Util-C76gCxal.js";import{r as W,e as z}from"./ContentObject-tLjB2Ud3.js";import{d as tt}from"./triangle-aMXw_G3u.js";import{e as E}from"./VertexAttribute-BnAa5VW0.js";import{t as it}from"./doublePrecisionUtils-B0owpBza.js";let et=class{constructor(t){this.channel=t,this.id=F()}};function nt(r,t){return r==null&&(r=[]),r.push(t),r}function st(r,t){if(r==null)return null;const i=r.filter(n=>n!==t);return i.length===0?null:i}function It(r,t,i,n,s){C[0]=r.get(t,0),C[1]=r.get(t,1),C[2]=r.get(t,2),it(C,A,3),i.set(s,0,A[0]),n.set(s,0,A[1]),i.set(s,1,A[2]),n.set(s,1,A[3]),i.set(s,2,A[4]),n.set(s,2,A[5])}const C=$(),A=new Float32Array(6);function rt(r){if(r.length<H)return Array.from(r);if(Y(r))return Float64Array.from(r);if(!("BYTES_PER_ELEMENT"in r))return Array.from(r);switch(r.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(r);case 2:return R(r)?Uint16Array.from(r):Int16Array.from(r);case 4:return Float32Array.from(r);default:return Float64Array.from(r)}}class S{constructor(t,i,n){this.primitiveIndices=t,this._numIndexPerPrimitive=i,this.position=n,this._children=void 0,T(t.length>=1),T(n.size===3||n.size===4);const{data:s,size:o,indices:h}=n;T(h.length%this._numIndexPerPrimitive==0),T(h.length>=t.length*this._numIndexPerPrimitive);const u=t.length;let a=o*h[this._numIndexPerPrimitive*t[0]];M.clear(),M.push(a);const c=D(s[a],s[a+1],s[a+2]),e=J(c);for(let m=0;m<u;++m){const f=this._numIndexPerPrimitive*t[m];for(let _=0;_<this._numIndexPerPrimitive;++_){a=o*h[f+_],M.push(a);let g=s[a];c[0]=Math.min(g,c[0]),e[0]=Math.max(g,e[0]),g=s[a+1],c[1]=Math.min(g,c[1]),e[1]=Math.max(g,e[1]),g=s[a+2],c[2]=Math.min(g,c[2]),e[2]=Math.max(g,e[2])}}this.bbMin=c,this.bbMax=e;const l=U($(),this.bbMin,this.bbMax,.5);this.radius=.5*Math.max(Math.max(e[0]-c[0],e[1]-c[1]),e[2]-c[2]);let p=this.radius*this.radius;for(let m=0;m<M.length;++m){a=M.at(m);const f=s[a]-l[0],_=s[a+1]-l[1],g=s[a+2]-l[2],y=f*f+_*_+g*g;if(y<=p)continue;const w=Math.sqrt(y),L=.5*(w-this.radius);this.radius=this.radius+L,p=this.radius*this.radius;const O=L/w;l[0]+=f*O,l[1]+=_*O,l[2]+=g*O}this.center=l,M.clear()}getChildren(){if(this._children||X(this.bbMin,this.bbMax)<=1)return this._children;const t=U($(),this.bbMin,this.bbMax,.5),i=this.primitiveIndices.length,n=new Uint8Array(i),s=new Array(8);for(let e=0;e<8;++e)s[e]=0;const{data:o,size:h,indices:u}=this.position;for(let e=0;e<i;++e){let l=0;const p=this._numIndexPerPrimitive*this.primitiveIndices[e];let m=h*u[p],f=o[m],_=o[m+1],g=o[m+2];for(let y=1;y<this._numIndexPerPrimitive;++y){m=h*u[p+y];const w=o[m],L=o[m+1],O=o[m+2];w<f&&(f=w),L<_&&(_=L),O<g&&(g=O)}f<t[0]&&(l|=1),_<t[1]&&(l|=2),g<t[2]&&(l|=4),n[e]=l,++s[l]}let a=0;for(let e=0;e<8;++e)s[e]>0&&++a;if(a<2)return;const c=new Array(8);for(let e=0;e<8;++e)c[e]=s[e]>0?new Uint32Array(s[e]):void 0;for(let e=0;e<8;++e)s[e]=0;for(let e=0;e<i;++e){const l=n[e];c[l][s[l]++]=this.primitiveIndices[e]}this._children=new Array;for(let e=0;e<8;++e)c[e]!==void 0&&this._children.push(new S(c[e],this._numIndexPerPrimitive,this.position));return this._children}static prune(){M.prune()}}const M=new q({deallocator:null});function at(r,t){if(!r)return!1;const{size:i,data:n,indices:s}=r;x(t,0,0,0),x(b,0,0,0);let o=0,h=0;for(let u=0;u<s.length-2;u+=3){const a=s[u]*i,c=s[u+1]*i,e=s[u+2]*i;x(d,n[a],n[a+1],n[a+2]),x(P,n[c],n[c+1],n[c+2]),x(N,n[e],n[e+1],n[e+2]);const l=tt(d,P,N);l?(I(d,d,P),I(d,d,N),v(d,d,1/3*l),I(t,t,d),o+=l):(I(b,b,d),I(b,b,P),I(b,b,N),h+=3)}return(h!==0||o!==0)&&(o!==0?(v(t,t,1/o),!0):h!==0&&(v(t,b,1/h),!0))}function ht(r,t){if(!r)return!1;const{size:i,data:n,indices:s}=r;x(t,0,0,0);let o=-1,h=0;for(let u=0;u<s.length;u++){const a=s[u]*i;o!==a&&(t[0]+=n[a],t[1]+=n[a+1],t[2]+=n[a+2],h++),o=a}return h>1&&v(t,t,1/h),h>0}function ot(r,t,i){if(!r)return!1;x(i,0,0,0),x(b,0,0,0);let n=0,s=0;const{size:o,data:h,indices:u}=r,a=u.length-1,c=a+(t?2:0);for(let e=0;e<c;e+=2){const l=e<a?e+1:0,p=u[e<a?e:a]*o,m=u[l]*o;d[0]=h[p],d[1]=h[p+1],d[2]=h[p+2],P[0]=h[m],P[1]=h[m+1],P[2]=h[m+2],v(d,I(d,d,P),.5);const f=Z(d,P);f>0?(I(i,i,v(d,d,f)),n+=f):n===0&&(I(b,b,d),s++)}return n!==0?(v(i,i,1/n),!0):s!==0&&(v(i,b,1/s),!0)}const d=$(),P=$(),N=$(),b=$();class j extends W{constructor(t,i,n=null,s=z.Mesh,o=null,h=-1){super(),this.material=t,this.mapPositions=n,this.type=s,this.objectAndLayerIdColor=o,this.edgeIndicesLength=h,this.visible=!0,this._attributes=new Map,this._boundingInfo=null;for(const[u,a]of i)this._attributes.set(u,{...a,indices:K(a.indices)}),u===E.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._attributes.get(u).indices.length:this.edgeIndicesLength)}instantiate(t={}){const i=new j(t.material||this.material,[],this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._attributes.forEach((n,s)=>{n.exclusive=!1,i._attributes.set(s,n)}),i._boundingInfo=this._boundingInfo,i.transformation=t.transformation||this.transformation,i}get attributes(){return this._attributes}getMutableAttribute(t){let i=this._attributes.get(t);return i&&!i.exclusive&&(i={...i,exclusive:!0,data:rt(i.data)},this._attributes.set(t,i)),i}setAttributeData(t,i){const n=this._attributes.get(t);n&&this._attributes.set(t,{...n,exclusive:!0,data:i})}get indexCount(){const t=this._attributes.values().next().value.indices;return(t==null?void 0:t.length)??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo==null&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(t){return!!(this.type===z.Mesh?this._computeAttachmentOriginTriangles(t):this.type===z.Line?this._computeAttachmentOriginLines(t):this._computeAttachmentOriginPoints(t))&&(this._transformation!=null&&k(t,t,this._transformation),!0)}_computeAttachmentOriginTriangles(t){const i=this.attributes.get(E.POSITION);return at(i,t)}_computeAttachmentOriginLines(t){const i=this.attributes.get(E.POSITION);return ot(i,ut(this.material.parameters,i),t)}_computeAttachmentOriginPoints(t){const i=this.attributes.get(E.POSITION);return ht(i,t)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const t=this.attributes.get(E.POSITION);if(!t||t.indices.length===0)return null;const i=this.type===z.Mesh?3:1;T(t.indices.length%i==0,"Indexing error: "+t.indices.length+" not divisible by "+i);const n=Q(t.indices.length/i);return new S(n,i,t)}get transformation(){return this._transformation??B}set transformation(t){this._transformation=t&&t!==B?G(t):null}addHighlight(){const t=new et(V.Highlight);return this.highlights=nt(this.highlights,t),t}removeHighlight(t){this.highlights=st(this.highlights,t)}}function ut(r,t){return!(!("isClosed"in r)||!r.isClosed)&&t.indices.length>2}export{j as I,st as a,It as l,nt as n,S as o,et as r};
