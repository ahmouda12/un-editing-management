import{es as M,o2 as O,o3 as W,bO as N,e2 as X,o4 as j,d_ as k,f as R,dl as C,ad as z,b5 as q,o5 as J}from"./index-B252NKV0.js";import{o as K}from"./LayerConstants-B33OP6sh.js";import{t as Q}from"./Material-5cwIpifF.js";import{a as m,i as U,o as S,e as Y,s as I,d as b,T as v,t as x,b as Z}from"./ElevationProvider-Z72XcWTz.js";import{n as tt,o as A}from"./Intersector-DFmhN7LU.js";import{i as T}from"./Intersector-Cp54otHo.js";import{w as L}from"./verticalOffsetUtils-Byw9d5zq.js";class ht extends S{constructor(e,n,r,i){super(n,r),this.point=e,this.createGraphic=i}}function F(t){return m(t)&&t.intersector===U.PCL&&!!t.target}let yt=class extends Y{constructor(e,n,r,i,c){super(e),this.layerUid=e,this.sublayerUid=n,this.nodeIndex=r,this.componentIndex=i,this.triangleNr=c}};class Ut extends S{constructor(e,n,r){super(n,null),this.point=e,this.createVoxelGraphic=r}}class $t extends S{constructor(e,n){super(e,null),this.createTiles3DGraphic=n}}function w(t){return m(t)&&t.intersector===U.I3S&&!!t.target}function _(t){return m(t)&&t.intersector===U.VOXEL&&!!t.target}function et(t){return m(t)&&t.intersector===U.TILES3D&&!!t.target}function H(t,e){var n,r;return I(t)||b(t)?h((n=t.target)==null?void 0:n.object,e):tt(t)?(r=e.map)==null?void 0:r.ground:F(t)||w(t)||A(t)||_(t)?h(t.target,e):null}function It(t,e){const n=V(t,e);return n!=null&&n.type==="graphic"?n.graphic:null}function V(t,e){var n;if(t==null)return null;if(I(t)||b(t))return G((n=t.target)==null?void 0:n.object,e);if(F(t)){const r=t.target.createGraphic();return{type:"graphic",graphic:r,layer:r.layer}}if(_(t)){const r=t.target.createVoxelGraphic();return{type:"graphic",graphic:r,layer:r.layer}}if(et(t)){const r=t.target.createTiles3DGraphic();return{type:"graphic",graphic:r,layer:r.layer}}return A(t)||T(t)?G(t.target,e):w(t)?nt(t.target,e):null}function G(t,e){if((t==null?void 0:t.graphicUid)==null)return null;const n=h(t,e);if(n==null)return null;if(n===e.graphics)return e.graphicsView==null||typeof t.graphicUid!="number"?null:e.graphicsView.getHit(t.graphicUid);const r=e.allLayerViews.find(i=>i.layer===n);return!r||r.suspended||t.graphicUid==null?null:"getHit"in r?r.getHit(t.graphicUid):null}function nt(t,e){const n=h(t,e);if(n==null)return null;const r=e.allLayerViews.find(i=>i.layer===n);return r&&!r.suspended&&"getGraphicFromIntersectorTarget"in r?it(r.getGraphicFromIntersectorTarget(t)):null}function rt(t,e){const n=h(t,e);if(n==null)return null;const r=e.allLayerViews.find(i=>i.layer===n);return r&&!r.suspended&&"getAABBFromIntersectorTarget"in r?r.getAABBFromIntersectorTarget(t):null}function it(t){return t!=null?{type:"graphic",graphic:t,layer:t.layer}:null}function h(t,e){return(t==null?void 0:t.layerUid)==null?null:e.graphicsView!=null&&t.layerUid===e.graphicsView.processor.layer.id?e.graphics:e.map.allLayers.find(n=>n.uid===t.layerUid)}function bt(t,e){if(I(t)||b(t))return M(t.target.object.boundingVolumeWorldSpace.bounds);if(T(t)){O($,t.transformation);const n=Math.max($[0],$[1],$[2]);return t.target.baseBoundingSphere.radius*n}if(w(t)){const n=rt(t.target,e);return n?.5*W(n):null}return null}function wt(t){return!I(t)&&!b(t)&&(T(t)?t.target.numLodLevels>1:!!w(t))}const $=N();async function xt(t,e,n,r){const i=n?B(t,n):r,c=X(e.x,e.y);i.requiresGroundFeedback=!0,i.enableDraped=!0;const a=v(t.state.viewingMode);a.options.selectionMode=!0,a.options.store=x.ALL,t.sceneIntersectionHelper.intersectIntersectorScreen(c,a,i);const o=st(t,a.results.all,i.graphics),s=a.results.ground,l=H(s,t),u=l!=null&&"type"in l&&j(l.type)?l:null,d={screenPoint:e,results:o,ground:{mapPoint:f(t,s),distance:m(s)?s.distanceInRenderSpace:0,layer:u}};return Q.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(d.intersector=a),d}function Lt(t,e,n,r){const i=n?B(t,n):r,c=i.graphics!=null&&(i.graphics.include!=null||i.graphics.exclude!=null),a=k(e);i.enableDraped=i.include&&!i.include.has(L)||i.exclude&&i.exclude.has(L);const o=t.sceneIntersectionHelper,s=v(t.state.viewingMode);if(s.options.selectionMode=!0,s.options.store=c?x.ALL:x.MIN,s.options.hud=!(n!=null&&n.excludeHud),o.intersectIntersectorScreen(a,s,i),c){for(const l of s.results.all){const u=V(l,t);if(u==null||u.type!=="graphic"||P(i.graphics,u.graphic))return f(t,l)}return null}return f(t,s.results.min)}function st(t,e,n){const r=new Array;let i=null;for(let c=0;c<e.length;c++){const a=e[c],o=H(a,t);if(o!=null&&(o===t.map.ground||"type"in o&&j(o.type)))break;const s=V(a,t);if(s==null)continue;if(s.type==="graphic"){if(i==null&&c!==e.length-1&&(i=new Set),i!=null){const d=D(s.graphic);if(i.has(d))continue;i.add(d)}if(!P(n,s.graphic))continue}const l=f(t,a),u=a.distanceInRenderSpace;if(s.type==="media"){const d=s.element.toSource(l);r.push({...s,mapPoint:l,distance:u,sourcePoint:d})}else r.push({...s,mapPoint:l,distance:u})}return r}function f(t,e,n){return e.getIntersectionPoint(p)?(n=at(t,p,n),e.intersector===U.TERRAIN&&t.basemapTerrain&&(n.z=Z(t.basemapTerrain,n)??0),n):null}function D(t){var i;const e=t.sourceLayer,n=t.layer,r=e&&"objectIdField"in e?e:n&&"objectIdField"in n?n:e;if(r){const c=r.objectIdField??K,a=(i=t.attributes)==null?void 0:i[c];if(a)return`o-${r.id}-${a}`}return`u-${t.uid}`}function P(t,e){const n=D(e);return t==null||(t.include==null||t.include.has(n))&&(t.exclude==null||!t.exclude.has(n))}function at(t,e,n){let r=t.spatialReference||R.WGS84;return C(e,t.renderSpatialReference,p,r)?e=p:(r=R.WGS84,C(e,t.renderSpatialReference,p,r)&&(e=p)),n?(n.x=e[0],n.y=e[1],n.z=e[2],n.spatialReference=r):n=new z(e,r),n}function B(t,e){const n=E(t,e.include,y.INCLUDE),r=E(t,e.exclude,y.EXCLUDE);return{include:n.layerUids,exclude:r.layerUids,graphics:{include:n.graphicUids,exclude:r.graphicUids}}}function E(t,e,n,r={layerUids:void 0,graphicUids:void 0}){if(!e)return r;if(e instanceof q)ct(r,D(e)),n===y.INCLUDE&&(t.graphicsView!=null&&e.layer===t?g(r,t.graphicsView.processor.layer.id):e.layer&&g(r,e.layer.uid));else if(J(e))for(const i of e)i===t.graphics&&t.graphicsView!=null?g(r,t.graphicsView.processor.layer.id):i===t.map.ground?g(r,L):E(t,i,n,r);else"uid"in e&&g(r,e.uid);return r}function g(t,e){t.layerUids||(t.layerUids=new Set),t.layerUids.add(e)}function ct(t,e){t.graphicUids||(t.graphicUids=new Set),t.graphicUids.add(e)}const p=N();var y;(function(t){t[t.INCLUDE=0]="INCLUDE",t[t.EXCLUDE=1]="EXCLUDE"})(y||(y={}));class Et{constructor(e){this._store=e}destroy(){this._store.destroy()}get(e){return this._store.get(e)}put(e,n){this._store.put(e,n,n.values.byteLength+256)}}export{B as L,bt as V,w as a,xt as b,Ut as c,Lt as j,$t as l,It as m,yt as o,et as p,ht as s,Et as t,wt as w,at as x};
