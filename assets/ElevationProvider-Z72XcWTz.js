import{c3 as V,cM as J,bO as m,dP as u,en as I,dQ as S,j_ as $,ca as j,cs as w,c8 as x,ce as X,c5 as T,ek as z,cx as H,cz as k,eb as W,dZ as M,n_ as C,ee as Q}from"./index-B252NKV0.js";import{u as Y}from"./boundedPlane-YCrsjrS8.js";import{v as q,d as B}from"./verticalOffsetUtils-Byw9d5zq.js";var c,O;(function(r){r[r.OBJECT=0]="OBJECT",r[r.HUD=1]="HUD",r[r.TERRAIN=2]="TERRAIN",r[r.OVERLAY=3]="OVERLAY",r[r.I3S=4]="I3S",r[r.PCL=5]="PCL",r[r.LOD=6]="LOD",r[r.VOXEL=7]="VOXEL",r[r.TILES3D=8]="TILES3D"})(c||(c={}));let F=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=O.ALL}};(function(r){r[r.MIN=0]="MIN",r[r.MINMAX=1]="MINMAX",r[r.ALL=2]="ALL"})(O||(O={}));let Z=class{constructor(t,s,e){this.object=t,this.geometryId=s,this.triangleNr=e}},K=class extends Z{constructor(t,s,e,a){super(t,s,e),this.center=a!=null?V(a):null}};class tt{constructor(t){this.layerUid=t}}let dt=class extends tt{constructor(t,s){super(t),this.graphicUid=s}};function b(r){return(r==null?void 0:r.dist)!=null}function ft(r){return(t,s,e)=>(J(N,t,s,e),!Y(r,N))}function yt(r){return b(r)&&r.intersector===c.OBJECT&&!!r.target}function mt(r){return b(r)&&r.intersector===c.HUD&&!!r.target&&"center"in r.target&&r.target.center!=null}const N=m(),D=1e-5;class rt{constructor(t){this.options=new F,this._results=new st,this.transform=new q,this.tolerance=D,this.verticalOffset=null,this._ray=u(),this._rayEnd=m(),this._rayBeginTransformed=m(),this._rayEndTransformed=m(),this.viewingMode=t??I.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,s,e){this.resetWithRay(S(t,s,this._ray),e)}resetWithRay(t,s){this.camera=s,t!==this._ray&&$(t,this._ray),this.options.verticalOffset!==0?this.viewingMode===I.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,j(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(t=null,s,e,a,o){var l;this.point=s,this.filterPredicate=a,this.tolerance=e??D;const f=B(this.verticalOffset);if(t&&t.length>0){const y=o?i=>{o(i)&&this.intersectObject(i)}:i=>{this.intersectObject(i)};for(const i of t){const d=(l=i.getSpatialQueryAccelerator)==null?void 0:l.call(i);d!=null?(f!=null?d.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,y,f):d.forEachAlongRay(this._ray.origin,this._ray.direction,y),this.options.selectionMode&&this.options.hud&&d.forEachDegenerateObject(y)):i.objects.forAll(_=>y(_))}}this.sortResults()}intersectObject(t){const s=t.geometries;if(!s)return;const e=t.effectiveTransformation,a=B(this.verticalOffset);for(const o of s){if(!o.visible)continue;const{material:f,id:l}=o;this.transform.setAndInvalidateLazyTransforms(e,o.transformation),w(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),w(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const y=this.transform.transform;a!=null&&(a.objectTransform=this.transform),f.intersect(o,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(i,d,_,A,L,G)=>{if(i>=0){if(this.filterPredicate!=null&&!this.filterPredicate(this._ray.origin,this._rayEnd,i))return;const n=A?this._results.hud:this._results,E=A?h=>{const P=new K(t,l,_,G);h.set(c.HUD,P,i,d,C,L)}:h=>h.set(c.OBJECT,{object:t,geometryId:l,triangleNr:_},i,d,y,L);if((n.min.drapedLayerOrder==null||L>=n.min.drapedLayerOrder)&&(n.min.dist==null||i<n.min.dist)&&E(n.min),this.options.store!==O.MIN&&(n.max.drapedLayerOrder==null||L<n.max.drapedLayerOrder)&&(n.max.dist==null||i>n.max.dist)&&E(n.max),this.options.store===O.ALL)if(A){const h=new R(this._ray);E(h),this._results.hud.all.push(h)}else{const h=new p(this._ray);E(h),this._results.all.push(h)}}})}}sortResults(t=this._results.all){t.sort((s,e)=>s.dist!==e.dist?(s.dist??0)-(e.dist??0):s.drapedLayerOrder!==e.drapedLayerOrder?U(s.drapedLayerOrder,e.drapedLayerOrder):U(s.drapedLayerGraphicOrder,e.drapedLayerGraphicOrder))}}function U(r,t){return(t??-Number.MAX_VALUE)-(r??-Number.MAX_VALUE)}function pt(r){return new rt(r)}class st{constructor(){this.min=new p(u()),this.max=new p(u()),this.hud={min:new R(u()),max:new R(u()),all:new Array},this.ground=new p(u()),this.all=[]}init(t){this.min.init(t),this.max.init(t),this.ground.init(t),this.all.length=0,this.hud.min.init(t),this.hud.max.init(t),this.hud.all.length=0}}class p{get ray(){return this._ray}get distanceInRenderSpace(){return this.dist!=null?(x(v,this.ray.direction,this.dist),X(v)):null}getIntersectionPoint(t){return!!b(this)&&(x(v,this.ray.direction,this.dist),j(t,this.ray.origin,v),!0)}getTransformedNormal(t){return T(g,this.normal),g[3]=0,z(g,g,this.transformation),T(t,g),H(t,t)}constructor(t){this.intersector=c.OBJECT,this.normal=m(),this.transformation=k(),this._ray=u(),this.init(t)}init(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=c.OBJECT,$(t,this._ray)}set(t,s,e,a,o,f,l){this.intersector=t,this.dist=e,T(this.normal,a??W),M(this.transformation,o??C),this.target=s,this.drapedLayerOrder=f,this.drapedLayerGraphicOrder=l}copy(t){$(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,T(this.normal,t.normal),M(this.transformation,t.transformation)}}class R extends p{constructor(){super(...arguments),this.intersector=c.HUD}}function gt(r){return new p(r)}const v=m(),g=Q();function et(r){return r.type==="point"}class Ot{constructor(t,s=null,e=0){this.array=t,this.spatialReference=s,this.offset=e}}function it(r){return"array"in r}function _t(r,t,s="ground"){if(et(t))return r.getElevation(t.x,t.y,t.z||0,t.spatialReference,s);if(it(t)){let e=t.offset;return r.getElevation(t.array[e++],t.array[e++],t.array[e]||0,t.spatialReference??r.spatialReference,s)}return r.getElevation(t[0],t[1],t[2]||0,r.spatialReference,s)}export{D as E,gt as G,pt as T,b as a,_t as b,et as c,mt as d,tt as e,it as f,ft as g,c as i,dt as o,Ot as r,yt as s,O as t};
