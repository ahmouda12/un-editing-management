import{hw as P,eV as D,aH as $,ba as T,bd as J,f as V,aE as x,aL as Q,aM as q,aN as H,r as M,t as j,u as W,aP as z,v as E,s as w,x as d,y as l,a3 as G,B as U,nA as g,nB as b,a8 as B,ab as K,eQ as X,cR as Y,fs as Z,nC as ee,nD as te,aU as I,Q as re}from"./index-B252NKV0.js";import{p as F,g as ie,m as se,h as oe,b as ae,I as ne}from"./applyEditsUtils-1oGLhBNQ.js";import{checkEditingCapabilities as de,normalizeEdits as ue,normalizeGeometries as le}from"./editingSupport-CyNhTx-n.js";import"./normalizeUtils-PvjooRb6.js";import"./normalizeUtilsCommon-ByXMGwNF.js";function pe(e){return{data:ce(e),sync:ye(e),operations:he(e.capabilities,e),query:ve(e),editing:ge(e)}}function ce(e){return{isDataVersioned:g(e,"hasVersionedData",!1)}}function he(e,t){const r=e?e.toLowerCase().split(",").map(n=>n.trim()):[],i=r.includes("query"),a=r.includes("editing")&&!t.datesInUnknownTimezone;let o=a&&r.includes("create"),s=a&&r.includes("delete"),u=a&&r.includes("update");return a&&!(o||s||u)&&(o=s=u=!0),{supportsAdd:o,supportsDelete:s,supportsEditing:a,supportsChangeTracking:r.includes("changetracking"),supportsQuery:i,supportsQueryDataElements:g(t,"supportsQueryDataElements",!1),supportsQueryDomains:g(t,"supportsQueryDomains",!1),supportsQueryContingentValues:g(t,"supportsQueryContingentValues",!1),supportsSync:r.includes("sync"),supportsUpdate:u}}function ve(e){return{maxRecordCountFactor:b(e,"maxRecordCountFactor",void 0),maxRecordCount:b(e,"maxRecordCount",void 0)}}function ge(e){const t=e==null?void 0:e.advancedEditingCapabilities;return{supportsGlobalId:g(e,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:g(t,"supportsReturnServiceEditsInSourceSR",!1),supportsSplit:g(t,"supportsSplit",!1),supportsAsyncApplyEdits:g(t,"supportsAsyncApplyEdits",!1)}}function ye(e){const t=e==null?void 0:e.syncCapabilities,r=t==null?void 0:t.supportedSyncDataOptions;return{supportsAsync:g(t,"supportsAsync",!1),supportedSyncDataOptions:{annotations:(1&r)==1,dimensions:(2&r)==2,contingentValues:(4&r)==4,attributeRules:(8&r)==8,utilityNetworkSystem:(16&r)==16,annotationFullModel:(32&r)==32,include3DObjects:(64&r)==64,utilityNetworkMissingLayers:(128&r)==128,preserveTrueCurves:(256&r)==256}}}let h=class extends P(D($)){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.userTypeExtensions=[],this.layerInfos=[],this.tableInfos=[],this.capabilities=null}read(e,t){this.sourceJSON=e,super.read(e,t)}get utilityNetworkUrl(){for(const e of this.sourceJSON.layers)if(e.type==="Utility Network Layer")return`${this.url}/${e.id}`;return null}get versionManagementServiceUrl(){return this.sourceJSON.hasBranchVersionedData?this.url.replace(/\/FeatureServer/i,"/VersionManagementServer"):null}readCapabilities(e,t){return pe(t)}load(e){return this.addResolvingPromise(this._fetchService(this.url,e)),Promise.resolve(this)}async applyEdits(e,t){let r=null;try{const{results:i,edits:a,editedFeatures:o}=await this._internalApplyEdits(e,t),s=n=>n.filter(c=>!c.error).map(T);let u=0;return i.map(n=>{r=J(this.url,n.id,t==null?void 0:t.gdbVersion,!0);const c={edits:a[u],addedFeatures:s(n.addFeatureResults),updatedFeatures:s(n.updateFeatureResults),deletedFeatures:s(n.deleteFeatureResults),addedAttachments:s(n.addAttachmentResults),updatedAttachments:s(n.updateAttachmentResults),deletedAttachments:s(n.deleteAttachmentResults),exceededTransferLimit:!1,historicMoment:n.editMoment?new Date(n.editMoment):null};u+=1,o.length>0&&(c.editedFeatures=o),r.resolve(c),r=null}),i}catch(i){throw r&&r.reject(i),i}}async _internalApplyEdits(e,t){const r=(t==null?void 0:t.globalIdUsed)??!1,i=V.fromJSON(this.sourceJSON.spatialReference),{edits:a,options:o}=await this._processApplyEditsParams(e,t),s=await Promise.all(a.map(async v=>{var k,L;const N=((k=v.addFeatures)==null?void 0:k.map(f=>F({spatialReference:i},f,null)))??[],_=(await Promise.all(N)).filter(x),C=((L=v.updateFeatures)==null?void 0:L.map(f=>F({spatialReference:i},f,null)))??[],S=(await Promise.all(C)).filter(x),O=ie(v.identifierFields,v.deleteFeatures,r);Q(_,S,i);const A=await se(v.identifierFields,v);return{id:v.id,adds:_,updates:S,deletes:O,attachments:A}})),u={gdbVersion:o==null?void 0:o.gdbVersion,rollbackOnFailure:!0,useGlobalIds:r,returnEditMoment:!0,honorSequenceOfEdits:o==null?void 0:o.honorSequenceOfEdits,usePreviousEditMoment:o==null?void 0:o.usePreviousEditMoment,returnServiceEditsInSourceSR:o==null?void 0:o.returnServiceEditsInSourceSR,returnServiceEditsOption:"originalAndCurrentFeatures",async:!1};await q(this.url,t==null?void 0:t.gdbVersion,!0);const n=H(this.url,(t==null?void 0:t.gdbVersion)||null);u.edits=JSON.stringify(s);const c=M(this.url),y=j(c.query,{query:W({...u,f:"json"}),method:"post"});let m;n&&(y.authMode="immediate",y.query.sessionId=z);try{m=await E(this.url+"/applyEdits",y)}catch(v){if(!oe(v))throw v;y.authMode="immediate",m=await E(this.url+"/applyEdits",y)}return{...this._createServiceEditsResult(m),edits:a}}_createServiceEditsResult(e){const t=e.data,r=[];return{results:t.map(i=>{const a={addResults:i.addResults??[],updateResults:i.updateResults??[],deleteResults:i.deleteResults??[],attachments:i.attachments,editMoment:i.editMoment},o=ae(a),s=i.editedFeatures,u=s!=null&&s.spatialReference?new V({wkid:s==null?void 0:s.spatialReference.wkid,wkt:s==null?void 0:s.spatialReference.wkt,latestWkid:s==null?void 0:s.spatialReference.latestWkid,latestVcsWkid:s==null?void 0:s.spatialReference.latestVcsWkid,vcsWkid:s==null?void 0:s.spatialReference.vcsWkid}):null,n=s?ne(s,u):null;return n&&r.push({layerId:i.id,editedFeatures:n}),{id:i.id,editedFeatures:n,...o}}),editedFeatures:r}}async _processApplyEditsParams(e,t){const r={...t};return{edits:await Promise.all(e.map(async i=>{const a=this.capabilities,o=i&&(i.addFeatures||i.updateFeatures||i.deleteFeatures),s=i&&(i.addAttachments||i.updateAttachments||i.deleteAttachments);if(de(i,a,t,!!o,!!s,"feature-service"),!a.data.isDataVersioned&&(t==null?void 0:t.gdbVersion))throw new w("feature-service:invalid-parameter","'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isVersioned'");const u=ue(i,a,"feature-service");return{...await le(u),id:i.id,identifierFields:i.identifierFields}})),options:r}}async _fetchService(e,t){if(this.sourceJSON)return void this.read(this.sourceJSON,{origin:"service",url:M(e)});const r=await E(e,{responseType:"json",query:{f:"json"},...t});this.read(r.data)}};d([l()],h.prototype,"url",void 0),d([l()],h.prototype,"sourceJSON",void 0),d([l({readOnly:!0})],h.prototype,"utilityNetworkUrl",null),d([l({readOnly:!0})],h.prototype,"versionManagementServiceUrl",null),d([l()],h.prototype,"userTypeExtensions",void 0),d([l({json:{read:{source:"layers"}}})],h.prototype,"layerInfos",void 0),d([l({json:{read:{source:"tables"}}})],h.prototype,"tableInfos",void 0),d([l({readOnly:!0,json:{read:{source:["hasVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"]}}})],h.prototype,"capabilities",void 0),d([G("service","capabilities")],h.prototype,"readCapabilities",null),h=d([U("esri.services.FeatureService")],h);const me=h,R=(e,t)=>{for(const r of e)if(r.type==="feature"||r.type==="subtype-group"){if(!r.url)continue;const i=B(r.url).url.path,a=t.get(i);if(a)a.layers.push(r);else{const o=new me({url:i}),s=[r];t.set(i,{featureService:o,layers:s})}}else r.type==="group"&&R(r.layers,t)};function fe(e){const t=new Map;return R(e,t),t}let p=class extends K{constructor(e){super(e),this._initialValidationsFinished=!1,this._portalLookup=new Map,this._updatingHandles=new X,this._validConstructProperties=!0,this.advancedEditingUserTypeExtensionLookup=new Map,this.executionError=void 0,this.featureServiceLookup=new Map,this.loadError=void 0,this.serverVersionLookup=new Map,this.serviceNameLookup=new Map,this.userLookup=new Map,this.versionIdentifierLookup=new Map,this.versionInfoLookup=new Map,this.versionManagementServiceLookup=new Map}initialize(){this.addHandles([Y(()=>{var e;return(e=this.view)==null?void 0:e.map.layers.toArray()},async()=>{await this._onLayersChange()},Z)])}destroy(){this._updatingHandles.destroy()}get state(){return this.loadError||!this._validConstructProperties?"disabled":this.executionError?"failed":this._updatingHandles.updating?"executing":this._initialValidationsFinished?"ready":"loading"}set view(e){this._get("view")!==e&&this._set("view",e)}async alterVersion(e){this.state!=="disabled"?await this._updatingHandles.addPromise((async()=>{this._setExecutionError();const t=this.versionManagementServiceLookup.get(e.featureServerUrl);if(!t)return void this._logNoVersionManagementServiceFoundError();if(!this.serverVersionLookup.has(e.featureServerUrl)||this.serverVersionLookup.get(e.featureServerUrl)<=11.1)return void this._logError("execution-error","no-valid-enterprise-version");if(!this.advancedEditingUserTypeExtensionLookup.get(e.featureServerUrl))return void this._logError("execution-error","no-advanced-editing-user-type-extension");const{featureServerUrl:r,versionIdentifier:i,...a}=e;await t.alterVersion(i,a).catch(async o=>{await this.getVersionInfos(r,!0),this._logExecutionError(o)})})()):this._logError("load-error",this.loadError)}async changeVersion(e,t,r){this.state!=="disabled"?await this._updatingHandles.addPromise((async()=>{var s;this._setExecutionError();const i=this.versionManagementServiceLookup.get(e);if(!i)return void this._logNoVersionManagementServiceFoundError();const a=this.versionIdentifierLookup.get(e)??{name:i.defaultVersionIdentifier.name,guid:i.defaultVersionIdentifier.guid},o={name:t,guid:r};await i.changeVersion((s=this.view)==null?void 0:s.map,a,o).catch(u=>{this._logExecutionError(u)})&&this.versionIdentifierLookup.set(e,o)})()):this._logError("load-error",this.loadError)}async createVersion(e){this.state!=="disabled"?await this._updatingHandles.addPromise((async()=>{var u,n;this._setExecutionError();const t=e.featureServerUrl,r=this.versionManagementServiceLookup.get(t);if(!r)return void this._logNoVersionManagementServiceFoundError();const i=this.advancedEditingUserTypeExtensionLookup.get(e.featureServerUrl),a=this.userLookup.get(t).toUpperCase(),o=this._isEmptyString(e.ownerName)?a:(u=e.ownerName)==null?void 0:u.trim().toUpperCase();if(o!==a){if(this.serverVersionLookup.get(t)<=11.1)return void this._logError("execution-error","versioning-api-error");if(!i)return void this._logError("execution-error","no-advanced-editing-user-type-extension")}if((o==null?void 0:o.toUpperCase())==="SDE"&&e.versionName.toUpperCase()==="DEFAULT"||(n=this.versionInfoLookup.get(t))!=null&&n.find(c=>c.versionIdentifier.name.toUpperCase()===(o+"."+e.versionName).toUpperCase()||c.versionIdentifier.name.toUpperCase()===(a+"."+e.versionName).toUpperCase()))return void this._logError("execution-error","no-valid-version-name");const s=await r.createVersion({versionName:e.versionName,access:o!==a?"public":e.access,description:e.description}).catch(c=>{this._logExecutionError(c)});if(!this.executionError&&o!==a){const{guid:c,name:y}=s.versionIdentifier,m={featureServerUrl:t,versionIdentifier:{guid:c,name:y},access:e.access,ownerName:o};await this.alterVersion(m),this.executionError&&this.deleteVersion(t,a+"."+e.versionName,s.versionIdentifier.guid)}await this.getVersionInfos(t,!0)})()):this._logError("load-error",this.loadError)}async deleteVersion(e,t,r){this.state!=="disabled"?await this._updatingHandles.addPromise((async()=>{this._setExecutionError();const i=this.versionManagementServiceLookup.get(e);if(!i)return void this._logNoVersionManagementServiceFoundError();if(this.serverVersionLookup.get(e)<=11.1)return void this._logError("execution-error","versioning-api-error");if(!this.advancedEditingUserTypeExtensionLookup.get(e))return void this._logError("execution-error","no-advanced-editing-user-type-extension");const a={name:t,guid:r};await i.deleteVersion(a).catch(o=>{this._logExecutionError(o)})&&await this.getVersionInfos(e,!0).catch(o=>{this._logExecutionError(o)})})()):this._logError("load-error",this.loadError)}async getVersionInfos(e,t){if(this.state!=="disabled")return await this._updatingHandles.addPromise((async()=>{var a,o;this._setExecutionError();const r=(a=this.featureServiceLookup.get(e))==null?void 0:a.featureService;if(!r)return void this._logError("execution-error","no-feature-service-found");if(!r.loaded){await r.load().catch(n=>{this._logExecutionError(n)});const s=r.url;this.serverVersionLookup.set(s,((o=r.sourceJSON)==null?void 0:o.currentVersion)??0),this.serverVersionLookup.get(s)<=11.1&&this.advancedEditingUserTypeExtensionLookup.set(s,!1);const u=this.userLookup.get(e);this._portalLookup.get(e)&&u?this.advancedEditingUserTypeExtensionLookup.set(s,await ee(this._portalLookup.get(e),u,"advediting")):this.advancedEditingUserTypeExtensionLookup.set(s,!1)}r.versionManagementServiceUrl&&this.versionManagementServiceLookup.set(r.url,new te({url:r.versionManagementServiceUrl}));const i=this.versionManagementServiceLookup.get(e);if(i){if(i.loaded||await i.load().catch(s=>{this._logExecutionError(s)}),!this.versionInfoLookup.get(e)||t){const s=await i.getVersionInfos().catch(u=>{this._logExecutionError(u)});this.versionInfoLookup.set(e,s)}}else this._logNoVersionManagementServiceFoundError()})()),this.versionInfoLookup.get(e);this._logError("load-error",this.loadError)}_isEmptyString(e){return!e||e.trim().length===0}_logError(e,t){switch(e){case"load-error":this._setLoadError(t),I.getLogger(this).error(new w(e,t));break;case"execution-error":this._setExecutionError(t),I.getLogger(this).error(new w(e,t))}}_logExecutionError(e){this._logError("execution-error",e.message)}_logNoVersionManagementServiceFoundError(){this._logError("execution-error","no-version-management-service-found")}async _onLayersChange(){var e;if(this._initialValidationsFinished=!1,this._setLoadError(),this._validConstructProperties=!0,!this.view)return this._logError("load-error","no-view-property"),void(this._validConstructProperties=!1);if(this.featureServiceLookup=fe(this.view.map.layers),!this.featureServiceLookup.size)return this._logError("load-error","no-feature-services"),void(this._validConstructProperties=!1);for(const t of this.featureServiceLookup.keys())if(!this.serviceNameLookup.has(t)){this.serviceNameLookup.set(t,t.split("/").at(-2));const r=new re({authMode:"immediate",url:new URL(t).origin+"/portal"});await r.load(),this._portalLookup.set(t,r);const i=(e=r==null?void 0:r.user)==null?void 0:e.username;i&&this.userLookup.set(t,i)}this._initialValidationsFinished=!0}_setExecutionError(e){this._set("executionError",e)}_setLoadError(e){this._set("loadError",e)}};d([l()],p.prototype,"_initialValidationsFinished",void 0),d([l({readOnly:!0})],p.prototype,"advancedEditingUserTypeExtensionLookup",void 0),d([l({readOnly:!0})],p.prototype,"executionError",void 0),d([l()],p.prototype,"featureServiceLookup",void 0),d([l({readOnly:!0})],p.prototype,"loadError",void 0),d([l({readOnly:!0})],p.prototype,"serverVersionLookup",void 0),d([l()],p.prototype,"serviceNameLookup",void 0),d([l({readOnly:!0})],p.prototype,"state",null),d([l({readOnly:!0})],p.prototype,"userLookup",void 0),d([l({readOnly:!0})],p.prototype,"versionIdentifierLookup",void 0),d([l()],p.prototype,"versionInfoLookup",void 0),d([l()],p.prototype,"versionManagementServiceLookup",void 0),d([l()],p.prototype,"view",null),p=d([U("esri.widgets.VersionManagement.VersionManagementViewModel")],p);const Le=p;export{Le as default};
