import{b5 as Le,s as Y,cR as be,fs as De,eP as _e,gJ as Be,m4 as we,en as je,nT as ke,dt as Ge,di as ve,oa as K,ob as Ne,oc as $e,bO as Q,ca as xe,ff as ze,dl as We,dT as Je,aU as Te,x as D,y as Z,B as qe,cz as Ce}from"./index-DPJiPkbh.js";import{n as Xe,s as Ye}from"./mat3-CakTilsz.js";import{R as Ke}from"./computeTranslationToOriginAndRotation-DJULrcwj.js";import{x as Qe,f as Ze}from"./LayerElevationProvider-SVsxr2NJ.js";import{c as et,x as tt,L as it,i as ee,O as rt,E as st,u as ot,k as at,B as Me,g as Pe}from"./BufferView-D7hl-e1J.js";import{r as P,a as te,S as B,N as O,e as g,m as nt,d as lt,g as ie,t as M,n as re,i as V}from"./ILyr3DWasmPerSceneView-vPx4somd.js";import{t as mt}from"./WaterSurface.glsl-CP2trn1z.js";import{b as ct}from"./ElevationContext-DtSabp_5.js";import{n as pt}from"./LayerView3D-DQ1MECMx.js";import{i as dt,l as j,a as Ee}from"./DefaultUI-y65bhLzJ.js";import{s as $,e as A,u as Oe}from"./basicInterfaces-DngWxyLO.js";import{E as Ue,D as v}from"./enums-DSseSvdG.js";import{l as ht}from"./ElevationQueryTileCache-CV-7cE3j.js";import{i as ut,t as ft,G as gt}from"./ElevationProvider-DuAnZ1w5.js";import{e as yt}from"./ElevationRange-BrgM1moX.js";import{J as Ae}from"./orientedBoundingBox-BABDZfWD.js";import{a as bt,I as _t,b as wt}from"./EdgeShader.glsl-CSDpUb7H.js";import{s as vt}from"./RenderTexture-DnJ2aRW8.js";import{q as Ie,N as xt}from"./IntegerPassUniform-Cz4js9jy.js";import{t as k}from"./Attribute-B-NAci_J.js";import{c as Tt}from"./Normals-D9FGVH8S.js";import{e as G}from"./VertexAttribute-BnAa5VW0.js";import{A as Ct}from"./VertexColor.glsl-COPd45YS.js";import{u as Mt}from"./LayerView-DYVP3cuG.js";import"./Scheduler-B7taRppB.js";import"./debugFlags-BTuu0IjQ.js";import"./RenderState-DaVlEYWY.js";import"./ColorMaterial.glsl-yoRZJYnh.js";import"./Material-CcaRhBp-.js";import"./interfaces-CGza0uBR.js";import"./ContentObject-tLjB2Ud3.js";import"./Util-C76gCxal.js";import"./InterleavedLayout-nriK6Yun.js";import"./types-D0PSWh4d.js";import"./OrderIndependentTransparency-Dar7ikM6.js";import"./ShaderTechniqueConfiguration-Ba2Oo7i0.js";import"./hydratedFeatures-DhDSkMoS.js";import"./BindType-BmZEZMMh.js";import"./floatRGBA-CHZINRxm.js";import"./Texture-BRxaK8g9.js";import"./Geometry-BiufU1jP.js";import"./Indices-ijvqWnhD.js";import"./triangle-aMXw_G3u.js";import"./lineSegment-BXFQuctu.js";import"./doublePrecisionUtils-B0owpBza.js";import"./vec2f32-BbH2jxlN.js";import"./dehydratedFeatures-BVErPR64.js";import"./featureConversionUtils-DQOpYys3.js";import"./OptimizedFeature-CXeSoBCN.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./OptimizedGeometry-DLPswkPy.js";import"./edgeUtils-BrtbNrdR.js";import"./earcut-nZVQjWaZ.js";import"./DoubleArray-MGZZXTmk.js";import"./vec3-CkCkHRdL.js";import"./SnappingCandidate-O5eRSE6e.js";import"./triangulationUtils-19KnAipc.js";import"./deduplicate-BSZzOE1N.js";import"./RealisticTree.glsl-mVrbbLCg.js";import"./DefaultMaterial_COLOR_GAMMA-KFGBhAW-.js";import"./quat-B_RTSvGc.js";import"./resourceUtils-BOaxdhtD.js";import"./NestedMap-DgiGbX8E.js";import"./requestImageUtils-QtRT18sL.js";import"./verticalOffsetUtils-5CRVG66a.js";import"./symbolColorUtils-PbK7g70N.js";import"./CIMSymbolHelper-Do5YMnYc.js";import"./BidiEngine-BwB1Df7c.js";import"./fontUtils-CPCkP0Vo.js";import"./GeometryUtils-CYtATAOa.js";import"./enums-BRqP_wXA.js";import"./definitions-B54owTRu.js";import"./Rect-CUzevAry.js";import"./BoundingBox-BhuXqU4L.js";import"./line-BSkXm7S3.js";import"./projectVectorToPoint-iRqWB51r.js";import"./MeshComponent-h79hEkUa.js";import"./imageUtils-CbDOqHX3.js";import"./meshVertexSpaceUtils-BjFcMx2J.js";import"./MeshLocalVertexSpace-BiaaX75A.js";import"./georeference-18LDVEFC.js";import"./spatialReferenceEllipsoidUtils-MJ9Uj9G-.js";import"./axisAngleDegrees-B1MWDIoz.js";import"./interfaces-DkjgzG8v.js";import"./frustum-0hRlYIm-.js";import"./DefaultLayouts-Drvj0JwT.js";import"./glUtil-DS73TAjp.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./Octree-CGixHoMx.js";import"./BufferObject-wa67LmxE.js";import"./Intersector-ovsF6jeJ.js";import"./weather-Ce7bakF4.js";import"./Intersector-G-a_ey6X.js";import"./VertexArrayObject-BGsrrzff.js";import"./vec3f32-Cw9Q6TO_.js";import"./heightModelInfoUtils-irmNrBgu.js";import"./ReactiveMap-sicXFvKD.js";import"./IViewEvents-Bci6PjlS.js";import"./interfaces-D6pIddIh.js";import"./mat2df64-CBKYtunK.js";import"./normalizeUtils-CVZirBXT.js";import"./normalizeUtilsCommon-DTYpWx_K.js";import"./capabilities-C84AMSCg.js";import"./themeUtils-C3zvZbsE.js";import"./accessibleHandler-XhnTPGUg.js";import"./Compass-DbISr2nW.js";import"./utils-DsJqvptN.js";import"./GoTo-28s5bp4H.js";import"./NavigationToggle-DiUrJhDe.js";import"./Zoom-D-LKGxB_.js";import"./LayerConstants-B33OP6sh.js";import"./boundedPlane-C7AEtm0i.js";import"./RenderCoordsHelper-DFKqBCUS.js";import"./scaleUtils-C37jhR61.js";import"./viewpointUtils-CgvaVEdA.js";import"./earthUtils-Dztb23Rc.js";import"./spatialReferenceSupport-CfW1ZJ7C.js";import"./ElevationSamplerData-2i_xP9yk.js";import"./terrainUtils-CqzNkC6w.js";import"./TileInfo-Lr1EBoW1.js";import"./TileKey-DZd6gJy7.js";import"./Environment-CUjcoIlu.js";import"./projectPointToWGS84ComparableLonLat-DpmzTiqz.js";import"./Program-DCRJBPTx.js";import"./ShadowCastVisualizeTechniqueConfiguration-B1R_waRt.js";import"./ray-cdkbAool.js";import"./ZoomMomentumEstimator-CGSDfs6t.js";import"./labelFormatUtils-D6Y1wMdU.js";import"./FeatureTileDescriptor3D-pKUnhSEa.js";import"./geometryServiceUtils-B1dYTJN2.js";import"./LercDecoder-B7XLyp93.js";import"./WorkerHandle-Vum6FPcM.js";import"./RenderableTile-0h8kMQ1Y.js";import"./enums-BRzLM11V.js";import"./TileStrategy-Bs8uTjKa.js";import"./TileKey-BicQgvrV.js";import"./QueueProcessor-DdpNWD80.js";import"./config-MDUrh2eL.js";import"./DefaultVertexAttributeLayouts-BBe0WA5l.js";import"./DisplayObject-jRWssau_.js";import"./rasterUtils-De8gyIVg.js";import"./StyleDefinition-pu9RBNlY.js";import"./resources-uOJIJyus.js";import"./edgeProcessing-B_9K5VFT.js";import"./EdgeWorkerHandle-D9CAJ86j.js";import"./workerHelper-BwdLYxhk.js";import"./testSVGPremultipliedAlpha-BaLE2eLV.js";import"./RenderingContext-CmYcri2p.js";import"./ProgramCache-EKFY6gsC.js";class Pt extends mt{constructor(e,l,o,c,s,a,h){super(e,0,0,0,l),this.nodesCached=o,this.vboMB=c,this.textureMB=s,this.vboMBCached=a,this.textureMBCached=h}}const Et={[P.Points]:null,[P.Lines]:null,[P.LineStrip]:null,[P.Triangles]:Ue.TRIANGLES,[P.TriangleStrip]:Ue.TRIANGLE_STRIP,[P.NotSet]:null},Re={[te.Opaque]:$.Opaque,[te.Mask]:$.Mask,[te.Blend]:$.Blend},Ot={[B.Back]:A.Back,[B.Front]:A.Front,[B.None]:A.None,[B.NotSet]:A.Back},Ut={[O.WrapYBit]:{s:v.CLAMP_TO_EDGE,t:v.REPEAT},[O.WrapXBit]:{s:v.REPEAT,t:v.CLAMP_TO_EDGE},[O.WrapXy]:{s:v.REPEAT,t:v.REPEAT},[O.None]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE},[O.NotSet]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE}},At={[g.U8]:1,[g.I8]:1,[g.U16]:2,[g.I16]:2,[g.U32]:4,[g.I32]:4,[g.F32]:4,[g.F64]:8,[g.Utf8String]:1,[g.NotSet]:1};class It{constructor(e){this.layerUid=[],this.type=ut.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,l,o,c){const s=e.results,a=e.options.store===ft.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const h=this.layerView.view._stage.renderView.componentObjectCollection;this.layerView.objects.forEach(b=>{b.visible&&b.intersectionGeometry&&h.intersect(b,o,c,e.tolerance,null,(x,d,f,m)=>{if(d>=0){if(l!=null&&!l(o,c,d))return;const n=i=>{const u=new ht(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));i.set(this.type,u,d,f)};if(this.isGround&&(s.ground.dist==null||d<s.ground.dist)&&n(s.ground),e.options.isFiltered)return;if((s.min.dist==null||d<s.min.dist)&&n(s.min),(s.max.dist==null||d>s.max.dist)&&n(s.max),a){const i=gt(e.ray);n(i),e.results.all.push(i)}}})})}_createTiles3DGraphic(e,l){return new Le({layer:e,sourceLayer:e,attributes:l})}}var y;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(y||(y={}));class Rt{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function N(t){return Math.round(t/1048.576)/1e3}let U=class extends pt(Mt){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=ct.WithoutRasterImage,this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(y.Error),this._dbg(y.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new Y("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const t=dt(this).then(e=>{this._intersectionHandler=new It(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,o=>this._slicePlaneEnabledChange(o)),this._elevationProvider=new Qe({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const l=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,o=>this._onRemoveFromCache(o));this._memCache=l,this._suspendedHandle=be(()=>this.suspended,o=>{const c=j(this.view);c&&c.setEnabled(this,!o)},De),this.addHandles([be(()=>this.layer.elevationInfo,o=>this._elevationInfoChanged(o))])}).catch(e=>{if(Ee(this),this._wasmLayerId=-1,e===nt)throw new Y("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===lt)throw new Y("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(y.VerboseAPI,"Tiles3DLayerView3D destroy() called"),Ee(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=_e(this._memCache),this._updatingHandles=_e(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle==null&&(this._visibleGeometryChangedSchedulerHandle=Be(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{const l=this._collection.getMaterial(e);l.commonMaterialParameters.hasSlicePlane=t,l.commonMaterialParameters.cullFace=t?A.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){const e=(t==null?void 0:t.offset)??0,l=t!=null&&t.unit?we(t==null?void 0:t.unit):1,o=j(this.view);o&&o.setLayerOffset(this,e*l)}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.totalMemory())}),t}get unloadedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.totalMemory())}),t}get performanceInfo(){let t=0,e=0,l=0,o=0,c=0,s=0;return this._lyrHandleToObjects.forEach(a=>{a.isVisible?(t+=a.texMemoryUsage,e+=a.vboMemoryUsage,c++):(l+=a.texMemoryUsage,o+=a.vboMemoryUsage,s++)}),new Pt(this.usedMemory,c,s,N(e),N(t),N(o),N(l))}_canProjectWithoutEngine(){var t,e;if(this.view.state.viewingMode===je.Local){const l=(t=this.view.renderSpatialReference)!=null&&t.isWebMercator?3857:((e=this.view.renderSpatialReference)==null?void 0:e.wkid)??-1;if(l!==3857&&l!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){var t,e;return(((t=this.layer.elevationInfo)==null?void 0:t.offset)??0)*((e=this.layer.elevationInfo)!=null&&e.unit?we(this.layer.elevationInfo.unit):1)}get elevationRange(){const t=this.fullExtent;return t!=null&&t.zmin&&(t!=null&&t.zmax)?new yt(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){const t=j(this.view);return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){var n;const e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");const l=ke(e.desc.origin),o=new Array,c=new Map,s=new Rt;s.handle=t.handle,this._lyrHandleToObjects.set(t.handle,s);const a=this.view.basemapTerrain.spatialReference;let h,b;if(this.view.viewingMode==="global"){const i=Ce();Ke(Ge,l,i,a),h=Xe(ve(),i),b=Ye(ve(),h)}else h=K,b=K;const x=Ce();Ne(x,x,l);const d=$e(Q(),x);let f=null;const m=Q();for(let i=0;i<e.desc.prims.length;i++){const u=e.desc.prims[i];if(u.ptype!==P.Lines||e.data==null)continue;const{positionView:p,positionAttr:E,indicesView:T}=this.getBufferViews(u,e.data.buffer,h,!1);E!=null&&p!=null&&T!=null&&(f=Ae(E),xe(m,f.center,l),f.center=m)}for(let i=0;i<e.desc.prims.length;i++){const u=e.desc.prims[i];if(this._dbg(y.VerboseAPI,JSON.stringify(u)),u.ptype===P.Lines)continue;if(Et[u.ptype]==null||e.data==null){this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+u.ptype+"). Skipping primitive.");continue}const p=(n=e.desc)!=null&&n.materials&&u.materialId!=null?e.desc.materials[u.materialId]:null,E=p!=null?p.lightingModel:ie.Unlit,T=E!==ie.Unlit,{positionView:_,positionAttr:C,normalsView:Ve,normalsAttr:z,colorAttr:F,texCoord0Attr:H,indicesView:I}=this.getBufferViews(u,e.data.buffer,h,T);if(C==null||_==null||I==null)continue;const se={colors:F!=null,textureCoordinates:H!=null?Ie.Default:Ie.None,hasNormals:Ve!=null,needsNormals:T},Fe=C.data.length/C.size,W=(r,w)=>!r||r.data.length/r.size===Fe||(this._dbg(y.Error,`${w} !== numPos. Skipping primitive.`),!1);if(!W(H,"numTexcoord")||!W(F,"numColors")||!W(z,"normals"))continue;const oe=bt(se);let R;if(f!=null?R=f.clone():(R=Ae(C),xe(m,R.center,l),R.center=m),h!==K)for(let r=0;r<_.count;r++)_.getVec(r,m),ze(m,m,h),_.setVec(r,m);const J=oe.createBuffer(C.data.length),S=new Map([[G.POSITION,C]]);H!=null&&S.set(G.UV0,H),F!=null&&S.set(G.COLOR,F),z!=null&&S.set(G.NORMALCOMPRESSED,z),S.forEach((r,w)=>{r!=null&&Ct(w,r,null,null,J,0)});const He=new Uint32Array([0,I.typedBuffer.length]),Se={vertices:{data:J.buffer,count:J.byteLength/oe.stride,layoutParameters:se},positionData:{positions:_.typedBuffer,indices:I.typedBuffer},indices:I.typedBuffer,componentOffsets:He};s.cpuMemoryUsage+=_.count,s.cpuMemoryUsage+=I.count;const ae=this.view.renderSpatialReference,q=Q(),X=[1,1,1];Ze(d,ae,X,a)||this._dbg(y.Error,"Unsupported coordinate system for IM overlay"),We(d,ae,q,a);const L=this._collection.createObject({toMapSpace:Je(q[0],q[1],X[0],X[1]),geometry:Se,obb:R,transform:{position:d,rotationScale:b}});p&&this._collection.updateMaterial(L,r=>{r.baseColor=p.baseColorFactor,r.usePBR=E===ie.Pbr,r.hasParametersFromSource=!1,r.baseColorTexture=this._getTexture(p.baseColorTex,e,c),r.usePBR&&(r.mrrFactors=[p.metallicFactor,p.roughnessFactor,0],r.emissiveFactor=p.emissiveFactor??[0,0,0],r.metallicRoughnessTexture=this._getTexture(p.metalTex,e,c),r.emissionTexture=this._getTexture(p.emissiveTex,e,c),r.occlusionTexture=this._getTexture(p.occlusionTex,e,c),r.normalTexture=this._getTexture(p.normalTex,e,c)),r.objectOpacity=0,r.alphaDiscardMode=$.Mask;const w=[];r.baseColorTexture&&w.push(r.baseColorTexture.loadPromise),r.usePBR&&r.metallicRoughnessTexture&&w.push(r.metallicRoughnessTexture.loadPromise),r.usePBR&&r.emissionTexture&&w.push(r.emissionTexture.loadPromise),r.usePBR&&r.occlusionTexture&&w.push(r.occlusionTexture.loadPromise),r.usePBR&&r.normalTexture&&w.push(r.normalTexture.loadPromise);const ne=Promise.all(w);o.push(ne),ne.then(()=>{var le,me,ce,pe,de,he,ue,fe,ge,ye;r.alphaDiscardMode=Re[p.alphaMode],r.objectOpacity=1,s.texMemoryUsage+=((me=(le=r.baseColorTexture)==null?void 0:le.glTexture)==null?void 0:me.usedMemory)||0,r.usePBR&&(s.texMemoryUsage+=((pe=(ce=r.metallicRoughnessTexture)==null?void 0:ce.glTexture)==null?void 0:pe.usedMemory)||0,s.texMemoryUsage+=((he=(de=r.emissionTexture)==null?void 0:de.glTexture)==null?void 0:he.usedMemory)||0,s.texMemoryUsage+=((fe=(ue=r.occlusionTexture)==null?void 0:ue.glTexture)==null?void 0:fe.usedMemory)||0,s.texMemoryUsage+=((ye=(ge=r.normalTexture)==null?void 0:ge.glTexture)==null?void 0:ye.usedMemory)||0)}),r.commonMaterialParameters.doubleSided=p.isDoubleSided,r.commonMaterialParameters.cullFace=p.faceCulling?Ot[p.faceCulling]:A.Back,this._initialCullFace.set(L,r.commonMaterialParameters.cullFace),r.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,r.componentParameters.castShadows=_t.All,r.textureAlphaCutoff=p.alphaCutoff??.1,r.alphaDiscardMode=Re[p.alphaMode],r.isIntegratedMesh=!0,r.polygonOffsetEnabled=!1,r.hasOccludees=!1,r.ellipsoidMode=wt(this.view.spatialReference)}),s.components.push(L),s.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(L)}if(await Promise.all(o),c.forEach(i=>{s.textures.push(i)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${s.handle}`,s,s.totalMemory()),{memUsageBytes:s.totalMemory()}}freeRenderable(t){const e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(l=>{this._stage.remove(l)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,l){if(this._memCache){for(let o=0;o<l;++o){const c=t[o],s=e[o];if(!s)continue;const a=this._lyrHandleToObjects.get(c);a&&(this._visibleGeometryChanged(),a.isVisible=s,a.components.forEach(h=>{this._collection.setObjectVisibility(h,s),this._elevationProvider.objectChanged(this._collection.getComponentObb(h))}),this._memCache.pop(`${c}`))}for(let o=0;o<l;++o){const c=t[o],s=e[o];if(s)continue;const a=this._lyrHandleToObjects.get(c);a&&(this._visibleGeometryChanged(),a.isVisible=s,a.components.forEach(h=>{this._collection.setObjectVisibility(h,s),this._elevationProvider.objectChanged(this._collection.getComponentObb(h))}),this._memCache.put(`${c}`,a,a.totalMemory()))}}}_getTexture(t,e,l){var c,s;let o=null;if(t&&((c=e.desc)!=null&&c.images)&&((s=e.data)!=null&&s.buffer)){const a=e.desc.images[t==null?void 0:t.imageId];if(o=l.get(a),!o&&a){const h=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,b=h>1,x=Ut[t.wrapMode??O.None];let d=a.alpha?4:3;const f=new Uint8Array(e.data.buffer,a.data.byteOffset,a.data.byteCount);let m=null,n=null,i=null;switch(a.format){case M.Raw:a.pixelFormat===re.R8?(m=f.buffer,d=1,n=""):a.pixelFormat===re.Rgb8?(m=f.buffer,d=3,n=""):a.pixelFormat===re.Rgba8&&(m=f.buffer,d=4,n="");break;case M.Dxt1:m=f.buffer,d=3,n=Oe.DDS_ENCODING;break;case M.Dxt5:m=f.buffer,d=4,n=Oe.DDS_ENCODING;break;case M.Png:n="image/png",i=document.createElement("img");break;case M.Jpeg:n="image/jpeg",i=document.createElement("img");break;case M.Etc2:n="image/ktx",i=document.createElement("img");break;case M.Astc:this._dbg(y.Error,"Astc texture not supported");break;case M.Pvrtc:this._dbg(y.Error,"Pvrtc texture not supported")}if(i&&n){const u=new Blob([f],{type:n});i.src=URL.createObjectURL(u),m=i}m&&n!=null&&(o=new xt(m,{mipmap:b,maxAnisotropy:h,encoding:n,wrap:x,components:d,noUnpackFlip:!0,width:a.mip0Width,height:a.mip0Height}),this._stage.add(o),l.set(a,o))}}return o?new vt(this.view._stage.renderView.textureRepository,o.id):null}getBufferViews(t,e,l,o){let c,s,a,h,b,x,d,f=null;for(let m=0;m<t.atrbs.length;m++){const n=t.atrbs[m],i=n.view,u=void 0,p=i.byteOffset+i.byteCount,E=i.byteCount/At[i.type],T=[...Array(E).keys()].map(_=>_);try{switch(n.sem){case V.Position:i.ncomp!==3||i.type!==g.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Position ("+i+")"):(c=new ee(e,i.byteOffset,u,p),s=new k(c.typedBuffer,T,3));break;case V.Normal:if(i.ncomp!==3||i.type!==g.F32)this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Normal ("+i+")");else if(o){const _=new ee(e,i.byteOffset,u,p),C=Tt(_.typedBuffer,l);b=new at(C),x=new k(b.typedBuffer,T,2)}break;case V.TexCoord:i.ncomp!==2||i.type!==g.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+i+")"):h===void 0&&(h=new k(new ot(e,i.byteOffset,u,p).typedBuffer,T,2));break;case V.Color:i.ncomp===4?(i.type===g.F32&&(f=new et(e,i.byteOffset,u,p)),i.type===g.U8&&(f=new tt(e,i.byteOffset,u,p)),i.type===g.U16&&(f=new it(e,i.byteOffset,u,p))):i.ncomp===3&&(i.type===g.F32&&(f=new ee(e,i.byteOffset,u,p)),i.type===g.U8&&(f=new rt(e,i.byteOffset,u,p)),i.type===g.U16&&(f=new st(e,i.byteOffset,u,p))),f==null?this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+i+")"):a=new k(f.typedBuffer,T,i.ncomp);break;case V.FeatureIndex:break;default:this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+n.sem+"). Skipping vertex attribute.")}}catch(_){this._dbg(y.VerboseAPI,"Error Creating buffer ("+_+"). Skipping vertex attribute.")}}if(t.index){const m=t.index.view,n=void 0,i=m.byteOffset+m.byteCount;switch(t.index.view.type){case g.U16:d=new Pe(e,m.byteOffset,n,i);break;case g.U32:d=new Me(e,m.byteOffset,n,i);break;case g.U8:default:this._dbg(y.Error,"[Unsupported Feature] index type not supported ("+m.type+").")}}if(d==null&&c!=null){const m=c.count;if(m<65535){const n=new Uint16Array(m);d=new Pe(n)}else{const n=new Uint32Array(m);d=new Me(n)}for(let n=0;n<m;n++)d.set(n,n)}return{positionView:c,positionAttr:s,colorAttr:a,texCoord0Attr:h,indicesView:d,normalsView:b,normalsAttr:x}}_onRemoveFromCache(t){const e=j(this.view);e&&e.onRenderableEvicted(this,t.handle,t.totalMemory()),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===y.Error?Te.getLogger(this).error(e):Te.getLogger(this).warn(e))}};D([Z()],U.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),D([Z()],U.prototype,"layer",void 0),D([Z()],U.prototype,"elevationOffset",null),U=D([qe("esri.views.3d.layers.Tiles3DLayerView3D")],U);const ws=U;export{ws as default};
